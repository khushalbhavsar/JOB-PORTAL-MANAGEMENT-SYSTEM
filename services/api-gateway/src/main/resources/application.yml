# =============================================
# API GATEWAY CONFIGURATION
# Job Portal Management System
# =============================================

server:
  port: 8080

spring:
  application:
    name: api-gateway
  
  cloud:
    gateway:
      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "*"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
            allowedHeaders: "*"
      
      # Default Filters
      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
      
      # Route Definitions
      routes:
        # Auth Service Routes
        - id: auth-service
          uri: ${AUTH_SERVICE_URL:http://localhost:8081}
          predicates:
            - Path=/api/auth/**
          filters:
            - RewritePath=/api/auth/(?<segment>.*), /api/auth/${segment}
            - name: CircuitBreaker
              args:
                name: authCircuitBreaker
                fallbackUri: forward:/fallback/auth
        
        # User Service Routes
        - id: user-service
          uri: ${USER_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/users/**
          filters:
            - RewritePath=/api/users/(?<segment>.*), /api/users/${segment}
            - name: CircuitBreaker
              args:
                name: userCircuitBreaker
                fallbackUri: forward:/fallback/users
        
        # Job Service Routes
        - id: job-service
          uri: ${JOB_SERVICE_URL:http://localhost:8083}
          predicates:
            - Path=/api/jobs/**
          filters:
            - RewritePath=/api/jobs/(?<segment>.*), /api/jobs/${segment}
            - name: CircuitBreaker
              args:
                name: jobCircuitBreaker
                fallbackUri: forward:/fallback/jobs
        
        # Application Service Routes
        - id: application-service
          uri: ${APPLICATION_SERVICE_URL:http://localhost:8084}
          predicates:
            - Path=/api/applications/**
          filters:
            - RewritePath=/api/applications/(?<segment>.*), /api/applications/${segment}
            - name: CircuitBreaker
              args:
                name: applicationCircuitBreaker
                fallbackUri: forward:/fallback/applications
        
        # Admin Service Routes
        - id: admin-service
          uri: ${ADMIN_SERVICE_URL:http://localhost:8085}
          predicates:
            - Path=/api/admin/**
          filters:
            - RewritePath=/api/admin/(?<segment>.*), /api/admin/${segment}
            - name: CircuitBreaker
              args:
                name: adminCircuitBreaker
                fallbackUri: forward:/fallback/admin
        
        # Recruiter Routes (User Service)
        - id: recruiter-service
          uri: ${USER_SERVICE_URL:http://localhost:8082}
          predicates:
            - Path=/api/recruiters/**
          filters:
            - RewritePath=/api/recruiters/(?<segment>.*), /api/recruiters/${segment}

# Resilience4j Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    instances:
      authCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
      userCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
      jobCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
      applicationCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
      adminCircuitBreaker:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
  timelimiter:
    instances:
      authCircuitBreaker:
        timeoutDuration: 3s
      userCircuitBreaker:
        timeoutDuration: 3s
      jobCircuitBreaker:
        timeoutDuration: 3s
      applicationCircuitBreaker:
        timeoutDuration: 3s
      adminCircuitBreaker:
        timeoutDuration: 3s

# Actuator Configuration
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# Logging
logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    reactor.netty: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
